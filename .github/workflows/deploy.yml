name: CI/CD - Build & Deploy (auto-detect app dir)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preflight: verify secrets and repo layout
        id: preflight
        shell: bash
        run: |
          set -e

          # --- Check secrets (without printing their values) ---
          missing=0
          for s in SSH_HOST SSH_USER SSH_PRIVATE_KEY SSH_TARGET_DIR; do
            if [ -z "${{ secrets[s] }}" ]; then
              echo "::error::Missing secret: $s"
              missing=1
            fi
          done
          # Optional port
          if [ -z "${{ secrets.SSH_PORT }}" ]; then
            echo "SSH_PORT not set; defaulting to 22"
            echo "port=22" >> $GITHUB_OUTPUT
          else
            echo "port=${{ secrets.SSH_PORT }}" >> $GITHUB_OUTPUT
          fi
          [ $missing -eq 1 ] && exit 1

          # --- Detect app directory automatically ---
          detect_dir() {
            if [ -f "package.json" ]; then
              echo "."
              return
            fi
            # common subfolder names — add more if needed
            for d in app web site fumescrubbers client frontend; do
              if [ -f "$d/package.json" ]; then
                echo "$d"
                return
              fi
            done
            echo ""
          }

          APP_DIR="$(detect_dir)"
          if [ -z "$APP_DIR" ]; then
            echo "::error::Could not find package.json in repo root or common subfolders."
            echo "::notice::Repo tree:"; ls -la; echo "::notice::"
            exit 1
          fi
          echo "Detected APP_DIR: $APP_DIR"
          echo "appdir=$APP_DIR" >> $GITHUB_OUTPUT
          echo "::group::Tree of $APP_DIR"; ls -la "$APP_DIR"; echo "::endgroup::"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ${{ steps.preflight.outputs.appdir }}/package-lock.json

      - name: Install deps
        working-directory: ${{ steps.preflight.outputs.appdir }}
        run: npm ci

      - name: Build
        working-directory: ${{ steps.preflight.outputs.appdir }}
        run: npm run build

      - name: Verify build output
        shell: bash
        run: |
          set -e
          APP_DIR="${{ steps.preflight.outputs.appdir }}"
          if [ ! -d "$APP_DIR/build" ]; then
            echo "::error::Build succeeded but no '$APP_DIR/build' folder was created."
            echo "::notice::Did you mean 'dist'? If so, change the workflow to upload that."
            exit 1
          fi
          echo "::group::Contents of $APP_DIR/build"
          ls -la "$APP_DIR/build"
          echo "::endgroup::"

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        shell: bash
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ steps.preflight.outputs.port }}" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy via rsync over SSH (build/ contents only)
        shell: bash
        run: |
          rsync -avzr --delete -e "ssh -p ${{ steps.preflight.outputs.port }}" \
            "${{ steps.preflight.outputs.appdir }}/build/" \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_TARGET_DIR }}/"

      # Fallback: if rsync not installed on runner or server, uncomment this SCP step and comment rsync above
      # - name: Deploy via scp (fallback)
      #   shell: bash
      #   run: |
      #     tar -C "${{ steps.preflight.outputs.appdir }}/build" -czf /tmp/site.tgz .
      #     scp -P ${{ steps.preflight.outputs.port }} /tmp/site.tgz "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_TARGET_DIR }}/"
      #     ssh -p ${{ steps.preflight.outputs.port }} "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" 'cd "${SSH_TARGET_DIR}" && tar xzf site.tgz && rm -f site.tgz'
