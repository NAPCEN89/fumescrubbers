name: CI/CD - Build & Deploy

on:
  push:
    branches: [ "main" ]

env:
  APP_DIR: "."   # change to a subfolder name if package.json is not at repo root

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preflight check (secrets & layout)
        id: preflight
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_TARGET_DIR: ${{ secrets.SSH_TARGET_DIR }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          APP_DIR: ${{ env.APP_DIR }}
        shell: bash
        run: |
          set -e
          # Required secrets present?
          missing=0
          for s in SSH_HOST SSH_USER SSH_PRIVATE_KEY SSH_TARGET_DIR; do
            if [ -z "${!s}" ]; then echo "::error::Missing secret: $s"; missing=1; fi
          done
          [ "$missing" -eq 1 ] && exit 1
          # Determine port
          PORT="${SSH_PORT:-22}"
          echo "port=$PORT" >> "$GITHUB_OUTPUT"
          # Check app dir and package.json
          if [ ! -f "$APP_DIR/package.json" ]; then
            echo "::error::package.json not found under APP_DIR='$APP_DIR'"; ls -la; exit 1
          fi
          echo "::group::Tree of $APP_DIR"; ls -la "$APP_DIR"; echo "::endgroup::"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ${{ env.APP_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.APP_DIR }}
        run: npm ci

      - name: Build
        working-directory: ${{ env.APP_DIR }}
        run: npm run build

      - name: Verify build output
        shell: bash
        run: |
          if [ ! -d "${{ env.APP_DIR }}/build" ]; then
            echo "::error::Build succeeded but no '${{ env.APP_DIR }}/build' folder was created."
            exit 1
          fi
          echo "::group::Contents of build/"
          ls -la "${{ env.APP_DIR }}/build"
          echo "::endgroup::"

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        shell: bash
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ steps.preflight.outputs.port }}" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy via rsync (build/ contents only)
        shell: bash
        run: |
          rsync -avzr --delete -e "ssh -p ${{ steps.preflight.outputs.port }}" \
            "${{ env.APP_DIR }}/build/" \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_TARGET_DIR }}/"
